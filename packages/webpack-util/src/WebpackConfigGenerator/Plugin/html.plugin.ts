import HTMLWebpackPlugin from "html-webpack-plugin";
import {ScriptTagCrossOriginPlugin} from "./script-tag-crossorigin-plugin.js";
import type {RspackPluginInstance} from "@rspack/core";
import type {HTMLEntryDescriptor} from "../../type.js";
import {WebpackConfigSerializationUtil} from "../WebpackConfigSerializationUtil.js";

interface HTMLPluginOptions {
    entry: HTMLEntryDescriptor;
    scriptLoading?: "module" | "defer";
    removeScriptTypeAttributes?: boolean; // default to true
}

/**
 * Creates a html file from a template with <script> and <link> injected
 * with the respective hashed output filenames.
 */
export function htmlPlugin({entry, scriptLoading = "defer", removeScriptTypeAttributes = true}: HTMLPluginOptions): RspackPluginInstance {
    return WebpackConfigSerializationUtil.serializablePlugin("HTMLWebpackPlugin", HTMLWebpackPlugin, {
        template: entry.htmlPath,
        filename: `${entry.name}.html`,
        chunks: [entry.name],
        scriptLoading,
        minify: {
            collapseBooleanAttributes: true,
            collapseInlineTagWhitespace: true,
            collapseWhitespace: true,
            includeAutoGeneratedTags: false,
            keepClosingSlash: true,
            minifyCSS: true,
            minifyJS: true,
            minifyURLs: true,
            removeAttributeQuotes: true,
            removeComments: true,
            removeEmptyAttributes: true,
            removeScriptTypeAttributes,
            removeRedundantAttributes: true,
            removeStyleLinkTypeAttributes: true,
            removeTagWhitespace: true,
            useShortDoctype: true,
        },
    });
}

/**
 * Adds attributes to `<script>` tag inside html file generated by
 * HTMLWebpackPlugin. Used to add `crossorigin="anonymous"`.
 */
export function scriptTagCrossOriginPlugin(): RspackPluginInstance {
    return WebpackConfigSerializationUtil.serializablePlugin("ScriptTagCrossOriginPlugin", ScriptTagCrossOriginPlugin);
}
